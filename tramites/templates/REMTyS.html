{% extends 'base.html' %}
{% load static %}

{% block title %}Inicio | REMTYS{% endblock %}

{% block content %}
<!-- Sección Hero con mensaje de bienvenida E ÍCONOS -->
<section class="hero-section">
    <div class="hero-content">
        <h1 class="hero-title">
            BIENVENIDO A<br>
            <span class="hero-highlight">TRÁMITES Y SERVICIOS</span>
        </h1>
        <div class="search-container">
            <input type="text" class="search-bar" id="searchInput" placeholder="Buscar trámite o servicio">
            <button class="search-button" id="searchButton">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 21L16.514 16.506L21 21ZM19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button class="clear-search" id="clearSearch" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>
</section>

<!-- Sección con SOLO el título del catálogo -->
<section class="catalog-intro-section">
    <!-- Título principal del catálogo - SOLO -->
    <div class="catalog-title-container">
        <h2 class="catalog-main-title" id="catalogTitle">
            CATÁLOGO MUNICIPAL DE<br>
            <span class="catalog-highlight">TRÁMITES Y SERVICIOS</span>
        </h2>
    </div>
</section>

<!-- Panel de Administración (solo para superadmin) -->
{% if user.is_authenticated and user.is_superuser %}
<div class="admin-panel">
    <div class="admin-header">
        <h2><i class="fas fa-users-cog"></i> Panel de Administración de Usuarios</h2>
        <button class="btn-admin" onclick="openCreateUserModal()">
            <i class="fas fa-user-plus"></i> Agregar Usuario
        </button>
    </div>
    
    <div class="admin-content">
        <div class="users-table-container">
            <table class="users-table" id="usersTable">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Área Asignada</th>
                        <th>Estado</th>
                        <th>Tipo</th>
                        <th>Fecha Registro</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Los datos se cargan dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para Crear/Editar Usuario -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Crear Usuario</h3>
            <span class="close" onclick="closeUserModal()">&times;</span>
        </div>
        <form id="userForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="username">Usuario *</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="first_name">Nombre</label>
                    <input type="text" id="first_name" name="first_name">
                </div>
                <div class="form-group">
                    <label for="last_name">Apellido</label>
                    <input type="text" id="last_name" name="last_name">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="password">Contraseña <span id="passwordRequired">*</span></label>
                    <input type="password" id="password" name="password">
                </div>
                <div class="form-group">
                    <label for="clasificacion">Área</label>
                    <select id="clasificacion" name="clasificacion">
                        <option value="">Sin área asignada</option>
                        <!-- Las opciones se cargan dinámicamente -->
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="is_active" name="is_active" checked>
                        Usuario Activo
                    </label>
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="is_staff" name="is_staff">
                        Administrador
                    </label>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeUserModal()">Cancelar</button>
                <button type="submit" class="btn-save" id="saveButton">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmación -->
<div id="confirmModal" class="modal">
    <div class="modal-content confirm-modal">
        <div class="modal-header">
            <h3>Confirmar Eliminación</h3>
            <span class="close" onclick="closeConfirmModal()">&times;</span>
        </div>
        <p id="confirmMessage">¿Estás seguro de que deseas eliminar este usuario?</p>
        <div class="modal-actions">
            <button type="button" class="btn-cancel" onclick="closeConfirmModal()">Cancelar</button>
            <button type="button" class="btn-delete" id="confirmDeleteBtn">Eliminar</button>
        </div>
    </div>
</div>

<div class="admin-separator"></div>
{% endif %}

<!-- Contenedor de resultados de búsqueda -->
<div class="search-results-container" id="searchResults" style="display: none;">
    <div class="search-info">
        <h3 id="searchResultsTitle">Resultados de búsqueda</h3>
        <button class="btn-back-catalog" onclick="showCatalog()">
            <i class="fas fa-arrow-left"></i> Volver al catálogo
        </button>
    </div>
    <div id="searchResultsContent"></div>
</div>

<!-- Sección de Áreas (catálogo original) -->
<div class="areas-grid" id="catalogGrid">
    {% for clasificacion in clasificaciones %}
        <a href="{% url 'ver_tramites' clasificacion.id %}" class="area-container">
            <div class="area-item">
                <img src="{% static clasificacion.imagen %}" alt="{{ clasificacion.nombre }}" class="area-image">
            </div>
            <h3 class="area-title">{{ clasificacion.nombre }}</h3>
        </a>
    {% empty %}
        <p>No hay clasificaciones disponibles.</p>
    {% endfor %}
</div>

<style>
/* Estilos para la búsqueda */
.search-container {
    position: relative;
    display: flex;
    align-items: center;
}

.clear-search {
    position: absolute;
    right: 50px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: #666;
    display: none;
}

.clear-search:hover {
    color: #333;
}

.search-results-container {
    margin: 2rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.search-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #dee2e6;
}

.search-info h3 {
    margin: 0;
    color: #333;
}

.btn-back-catalog {
    background: #007bff;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background-color 0.3s;
}

.btn-back-catalog:hover {
    background: #0056b3;
}

.search-section {
    margin-bottom: 2rem;
}

.search-section h4 {
    color: #495057;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    border-bottom: 2px solid #007bff;
    padding-bottom: 0.5rem;
}

.search-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: box-shadow 0.3s;
    cursor: pointer;
}

.search-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.search-item h5 {
    margin: 0 0 0.5rem 0;
    color: #333;
}

.search-item p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

.search-item-type {
    display: inline-block;
    background: #007bff;
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 3px;
    font-size: 0.8rem;
    margin-bottom: 0.5rem;
}

.search-item-type.clasificacion {
    background: #28a745;
}

.no-results {
    text-align: center;
    padding: 2rem;
    color: #666;
}

.loading-search {
    text-align: center;
    padding: 2rem;
    color: #007bff;
}
</style>

<script>
// Variables globales
let currentEditUserId = null;
let allClasificaciones = [];
let searchTimeout = null;
let isSearching = false;

// Cargar datos al inicio
document.addEventListener('DOMContentLoaded', function() {
    // Solo cargar usuarios si es superadmin
    if (document.getElementById('usersTable')) {
        loadUsers();
    }
    
    // Configurar búsqueda
    setupSearch();
});

// Configurar funcionalidad de búsqueda
function setupSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const clearSearch = document.getElementById('clearSearch');
    
    // Búsqueda en tiempo real mientras escribe
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length === 0) {
            showCatalog();
            clearSearch.style.display = 'none';
            return;
        }
        
        if (query.length >= 2) {
            clearSearch.style.display = 'block';
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300); // Esperar 300ms después de que termine de escribir
        }
    });
    
    // Búsqueda al hacer clic en el botón
    searchButton.addEventListener('click', function() {
        const query = searchInput.value.trim();
        if (query) {
            performSearch(query);
            // Scroll inmediato hacia los resultados al hacer clic en la lupa
            setTimeout(() => {
                const searchResultsElement = document.getElementById('searchResults');
                if (searchResultsElement.style.display !== 'none') {
                    searchResultsElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            }, 200);
        }
    });
    
    // Búsqueda al presionar Enter
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
                performSearch(query);
                // Scroll hacia los resultados al presionar Enter
                setTimeout(() => {
                    const searchResultsElement = document.getElementById('searchResults');
                    if (searchResultsElement.style.display !== 'none') {
                        searchResultsElement.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }
                }, 200);
            }
        }
    });
    
    // Limpiar búsqueda
    clearSearch.addEventListener('click', function() {
        searchInput.value = '';
        showCatalog();
        clearSearch.style.display = 'none';
        searchInput.focus();
    });
}

// Realizar búsqueda
async function performSearch(query) {
    if (isSearching) return;
    
    isSearching = true;
    showSearchResults();
    showLoadingSearch();
    
    try {
        const response = await fetch(`/api/buscar/?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (response.ok) {
            displaySearchResults(data, query);
        } else {
            showSearchError('Error al realizar la búsqueda');
        }
    } catch (error) {
        showSearchError('Error de conexión: ' + error.message);
    } finally {
        isSearching = false;
    }
}

// Mostrar contenedor de resultados
function showSearchResults() {
    document.getElementById('searchResults').style.display = 'block';
    document.getElementById('catalogGrid').style.display = 'none';
    
    // Scroll automático hacia los resultados con animación suave
    setTimeout(() => {
        const searchResultsElement = document.getElementById('searchResults');
        searchResultsElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }, 100); // Pequeño delay para que el elemento se muestre primero
}

// Mostrar catálogo original
function showCatalog() {
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('catalogGrid').style.display = 'grid';
    updateCatalogTitle();
    
    // Scroll suave hacia el catálogo (título principal)
    setTimeout(() => {
        const catalogTitle = document.getElementById('catalogTitle');
        catalogTitle.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
    }, 100);
}

// Actualizar título del catálogo
function updateCatalogTitle() {
    document.getElementById('catalogTitle').innerHTML = `
        CATÁLOGO MUNICIPAL DE<br>
        <span class="catalog-highlight">TRÁMITES Y SERVICIOS</span>
    `;
}

// Mostrar indicador de carga
function showLoadingSearch() {
    document.getElementById('searchResultsContent').innerHTML = `
        <div class="loading-search">
            <i class="fas fa-spinner fa-spin"></i> Buscando...
        </div>
    `;
}

// Mostrar error de búsqueda
function showSearchError(message) {
    document.getElementById('searchResultsContent').innerHTML = `
        <div class="no-results">
            <i class="fas fa-exclamation-triangle"></i>
            <p>${message}</p>
        </div>
    `;
}

// Mostrar resultados de búsqueda
function displaySearchResults(data, query) {
    const { clasificaciones, tramites, total } = data;
    
    // Actualizar título
    document.getElementById('searchResultsTitle').innerHTML = `
        Resultados para "<strong>${query}</strong>" (${total} encontrados)
    `;
    
    let html = '';
    
    if (total === 0) {
        html = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h4>No se encontraron resultados</h4>
                <p>No hay trámites o servicios que coincidan con "<strong>${query}</strong>"</p>
                <p>Intenta con otros términos de búsqueda</p>
            </div>
        `;
    } else {
        // Mostrar clasificaciones encontradas
        if (clasificaciones.length > 0) {
            html += `
                <div class="search-section">
                    <h4><i class="fas fa-folder"></i> Áreas (${clasificaciones.length})</h4>
            `;
            
            clasificaciones.forEach(clasificacion => {
                html += `
                    <div class="search-item" onclick="window.location.href='/tramites/${clasificacion.id}/'">
                        <span class="search-item-type clasificacion">ÁREA</span>
                        <h5>${clasificacion.nombre}</h5>
                        <p>Ver todos los trámites de esta área</p>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        // Mostrar trámites encontrados
        if (tramites.length > 0) {
            html += `
                <div class="search-section">
                    <h4><i class="fas fa-file-alt"></i> Trámites (${tramites.length})</h4>
            `;
            
            tramites.forEach(tramite => {
                html += `
                    <div class="search-item" onclick="window.location.href='/tramite/${tramite.id}/'">
                        <span class="search-item-type">TRÁMITE</span>
                        <h5>${tramite.nombre}</h5>
                        <p>${tramite.descripcion}</p>
                        <small><i class="fas fa-tag"></i> ${tramite.clasificacion_nombre}</small>
                    </div>
                `;
            });
            
            html += '</div>';
        }
    }
    
    document.getElementById('searchResultsContent').innerHTML = html;
}

// === RESTO DEL CÓDIGO EXISTENTE PARA USUARIOS ===

// Función para cargar usuarios
async function loadUsers() {
    try {
        const response = await fetch('/api/users/');
        const data = await response.json();
        
        if (data.error) {
            showAlert(data.error, 'error');
            return;
        }
        
        allClasificaciones = data.clasificaciones;
        populateClasificacionSelect();
        populateUsersTable(data.users);
    } catch (error) {
        showAlert('Error al cargar usuarios: ' + error.message, 'error');
    }
}

// Función para poblar la tabla de usuarios
function populateUsersTable(users) {
    const tbody = document.getElementById('usersTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    users.forEach(user => {
        const row = createUserRow(user);
        tbody.appendChild(row);
    });
}

// Función para crear una fila de usuario
function createUserRow(user) {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${user.username}</td>
        <td>${user.first_name} ${user.last_name}</td>
        <td>${user.email || '-'}</td>
        <td>${user.clasificacion_nombre}</td>
        <td>
            <span class="status-badge ${user.is_active ? 'active' : 'inactive'}">
                ${user.is_active ? 'Activo' : 'Inactivo'}
            </span>
        </td>
        <td>
            <span class="role-badge ${user.is_staff ? 'admin' : 'user'}">
                ${user.is_staff ? 'Admin' : 'Usuario'}
            </span>
        </td>
        <td>${user.date_joined}</td>
        <td class="actions">
            <button class="btn-action edit" onclick="editUser(${user.id})" title="Editar">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn-action delete" onclick="confirmDeleteUser(${user.id}, '${user.username}')" title="Eliminar">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    return row;
}

// Función para poblar el select de clasificaciones
function populateClasificacionSelect() {
    const select = document.getElementById('clasificacion');
    if (!select) return;
    
    select.innerHTML = '<option value="">Sin área asignada</option>';
    
    allClasificaciones.forEach(clasificacion => {
        const option = document.createElement('option');
        option.value = clasificacion.id;
        option.textContent = clasificacion.nombre;
        select.appendChild(option);
    });
}

// Función para abrir modal de crear usuario
function openCreateUserModal() {
    currentEditUserId = null;
    document.getElementById('modalTitle').textContent = 'Crear Usuario';
    document.getElementById('passwordRequired').style.display = 'inline';
    document.getElementById('password').required = true;
    document.getElementById('userForm').reset();
    document.getElementById('is_active').checked = true;
    document.getElementById('userModal').style.display = 'block';
}

// Función para editar usuario
function editUser(userId) {
    const tbody = document.getElementById('usersTableBody');
    const rows = tbody.getElementsByTagName('tr');
    
    for (let row of rows) {
        const cells = row.getElementsByTagName('td');
        if (cells.length > 0) {
            // Encontrar la fila del usuario y extraer datos
            const editBtn = row.querySelector('.btn-action.edit');
            if (editBtn && editBtn.getAttribute('onclick').includes(userId)) {
                currentEditUserId = userId;
                document.getElementById('modalTitle').textContent = 'Editar Usuario';
                document.getElementById('passwordRequired').style.display = 'none';
                document.getElementById('password').required = false;
                
                // Rellenar el formulario con los datos actuales
                document.getElementById('username').value = cells[0].textContent;
                const fullName = cells[1].textContent.split(' ');
                document.getElementById('first_name').value = fullName[0] || '';
                document.getElementById('last_name').value = fullName.slice(1).join(' ') || '';
                document.getElementById('email').value = cells[2].textContent !== '-' ? cells[2].textContent : '';
                
                // Encontrar la clasificación
                const clasificacionNombre = cells[3].textContent;
                const clasificacion = allClasificaciones.find(c => c.nombre === clasificacionNombre);
                document.getElementById('clasificacion').value = clasificacion ? clasificacion.id : '';
                
                // Estado y rol
                document.getElementById('is_active').checked = cells[4].textContent.includes('Activo');
                document.getElementById('is_staff').checked = cells[5].textContent.includes('Admin');
                
                document.getElementById('userModal').style.display = 'block';
                break;
            }
        }
    }
}

// Función para cerrar modal de usuario
function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
    document.getElementById('userForm').reset();
    currentEditUserId = null;
}

// Función para confirmar eliminación
function confirmDeleteUser(userId, username) {
    document.getElementById('confirmMessage').textContent = 
        `¿Estás seguro de que deseas eliminar al usuario "${username}"?`;
    document.getElementById('confirmDeleteBtn').onclick = () => deleteUser(userId);
    document.getElementById('confirmModal').style.display = 'block';
}

// Función para cerrar modal de confirmación
function closeConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
}

// Función para eliminar usuario
async function deleteUser(userId) {
    try {
        const response = await fetch('/api/users/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user_id: userId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            loadUsers();
        } else {
            showAlert(data.error, 'error');
        }
    } catch (error) {
        showAlert('Error al eliminar usuario: ' + error.message, 'error');
    }
    
    closeConfirmModal();
}

// Función para manejar el envío del formulario
document.getElementById('userForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const userData = {
        username: formData.get('username'),
        email: formData.get('email'),
        first_name: formData.get('first_name'),
        last_name: formData.get('last_name'),
        clasificacion_id: formData.get('clasificacion') || null,
        is_active: document.getElementById('is_active').checked,
        is_staff: document.getElementById('is_staff').checked
    };
    
    const password = formData.get('password');
    if (password) {
        userData.password = password;
    }
    
    if (currentEditUserId) {
        userData.user_id = currentEditUserId;
        if (password) {
            userData.new_password = password;
        }
    }
    
    const url = currentEditUserId ? '/api/users/update/' : '/api/users/create/';
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            closeUserModal();
            loadUsers();
        } else {
            showAlert(data.error, 'error');
        }
    } catch (error) {
        showAlert('Error al guardar usuario: ' + error.message, 'error');
    }
});

// Función para mostrar alertas
function showAlert(message, type) {
    // Crear el elemento de alerta
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        <span>${message}</span>
        <button type="button" class="alert-close" onclick="this.parentElement.remove()">×</button>
    `;
    
    // Insertar al inicio del contenido
    const content = document.querySelector('main') || document.body;
    content.insertBefore(alert, content.firstChild);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        if (alert.parentElement) {
            alert.remove();
        }
    }, 5000);
}

// Cerrar modales al hacer clic fuera de ellos
window.onclick = function(event) {
    const userModal = document.getElementById('userModal');
    const confirmModal = document.getElementById('confirmModal');
    
    if (event.target === userModal) {
        closeUserModal();
    }
    if (event.target === confirmModal) {
        closeConfirmModal();
    }
}
</script>

{% endblock %}