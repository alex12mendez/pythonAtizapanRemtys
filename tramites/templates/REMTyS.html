{% extends 'base.html' %}
{% load static %}

{% block title %}Inicio | REMTYS{% endblock %}

{% block content %}
<!-- Secci√≥n Hero con mensaje de bienvenida E √çCONOS -->
<section class="hero-section">
    <div class="hero-content">
        <h1 class="hero-title">
            BIENVENIDO A<br>
            <span class="hero-highlight">TR√ÅMITES Y SERVICIOS</span>
        </h1>
        <div class="search-container">
            <input type="text" class="search-bar" id="searchInput" placeholder="Buscar tr√°mite o servicio">
            <button class="search-button" id="searchButton">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 21L16.514 16.506L21 21ZM19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button class="clear-search" id="clearSearch" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
    </div>
</section>

<!-- Secci√≥n con SOLO el t√≠tulo del cat√°logo -->
<section class="catalog-intro-section">
    <!-- T√≠tulo principal del cat√°logo - SOLO -->
    <div class="catalog-title-container">
        <h2 class="catalog-main-title" id="catalogTitle">
            CAT√ÅLOGO MUNICIPAL DE<br>
            <span class="catalog-highlight">TR√ÅMITES Y SERVICIOS</span>
        </h2>
    </div>
</section>

<!-- Panel de Administraci√≥n (solo para superadmin) -->
{% if user.is_authenticated and user.is_superuser %}
<div class="admin-panel">
    <div class="admin-header">
        <h2><i class="fas fa-users-cog"></i> Panel de Administraci√≥n de Usuarios</h2>
        <button class="btn-admin" onclick="openCreateUserModal()">
            <i class="fas fa-user-plus"></i> Agregar Usuario
        </button>
    </div>
    
    <div class="admin-content">
        <div class="users-table-container">
            <table class="users-table" id="usersTable">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>√Årea Asignada</th>
                        <th>Estado</th>
                        <th>Tipo</th>
                        <th>Fecha Registro</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Los datos se cargan din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para Crear/Editar Usuario -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Crear Usuario</h3>
            <span class="close" onclick="closeUserModal()">&times;</span>
        </div>
        <form id="userForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="username">Usuario *</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="first_name">Nombre</label>
                    <input type="text" id="first_name" name="first_name">
                </div>
                <div class="form-group">
                    <label for="last_name">Apellido</label>
                    <input type="text" id="last_name" name="last_name">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="password">Contrase√±a <span id="passwordRequired">*</span></label>
                    <input type="password" id="password" name="password">
                </div>
                <div class="form-group">
                    <label for="clasificacion">√Årea</label>
                    <select id="clasificacion" name="clasificacion">
                        <option value="">Sin √°rea asignada</option>
                        <!-- Las opciones se cargan din√°micamente -->
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="is_active" name="is_active" checked>
                        Usuario Activo
                    </label>
                </div>
                <div class="form-group checkbox-group">
                    <label>
                        <input type="checkbox" id="is_staff" name="is_staff">
                        Administrador
                    </label>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeUserModal()">Cancelar</button>
                <button type="submit" class="btn-save" id="saveButton">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmaci√≥n -->
<div id="confirmModal" class="modal">
    <div class="modal-content confirm-modal">
        <div class="modal-header">
            <h3>Confirmar Eliminaci√≥n</h3>
            <span class="close" onclick="closeConfirmModal()">&times;</span>
        </div>
        <p id="confirmMessage">¬øEst√°s seguro de que deseas eliminar este usuario?</p>
        <div class="modal-actions">
            <button type="button" class="btn-cancel" onclick="closeConfirmModal()">Cancelar</button>
            <button type="button" class="btn-delete" id="confirmDeleteBtn">Eliminar</button>
        </div>
    </div>
</div>

<div class="admin-separator"></div>
{% endif %}

<!-- Panel de Protestas Ciudadanas (solo para superadmin) -->
{% if user.is_authenticated and user.is_superuser %}
<div class="protestas-panel">
    <div class="protestas-header">
        <h2><i class="fas fa-file-signature"></i> Panel de Protestas Ciudadanas</h2>
        <div class="protestas-controls">
            <input type="text" id="searchProtestas" placeholder="Buscar por folio, nombre o RFC..." class="search-protestas">
            <select id="statusFilter" class="status-filter">
                <option value="">Todos los estatus</option>
            </select>
            <button class="btn-refresh" onclick="loadProtestas()">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
        </div>
    </div>
    
    <div class="protestas-content">
        <div class="protestas-table-container">
            <table class="protestas-table" id="protestasTable">
                <thead>
                    <tr>
                        <th>Folio</th>
                        <th>Solicitante</th>
                        <th>Tr√°mite</th>
                        <th>√Årea</th>
                        <th>Estatus</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="protestasTableBody">
                    <!-- Los datos se cargan din√°micamente -->
                </tbody>
            </table>
        </div>
        
        <!-- Paginaci√≥n -->
        <div class="protestas-pagination" id="protestasPagination">
            <!-- Se carga din√°micamente -->
        </div>
    </div>
</div>

<!-- Modal para cambiar estatus -->
<div id="statusModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Cambiar Estatus de Protesta</h3>
            <span class="close" onclick="closeStatusModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p><strong>Folio:</strong> <span id="statusModalFolio"></span></p>
            <p><strong>Solicitante:</strong> <span id="statusModalSolicitante"></span></p>
            <p><strong>Estatus actual:</strong> <span id="statusModalCurrentStatus"></span></p>
            
            <div class="form-group">
                <label for="newStatus">Nuevo estatus:</label>
                <select id="newStatus" class="form-control">
                    <!-- Se llenan din√°micamente -->
                </select>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn-cancel" onclick="closeStatusModal()">Cancelar</button>
            <button type="button" class="btn-save" id="saveStatusBtn">Cambiar Estatus</button>
        </div>
    </div>
</div>

<!-- Modal para detalles de protesta -->
<div id="detailModal" class="modal">
    <div class="modal-content detail-modal-content">
        <div class="modal-header">
            <h3>Detalles de Protesta</h3>
            <span class="close" onclick="closeDetailModal()">&times;</span>
        </div>
        <div class="modal-body" id="detailModalBody">
            <!-- Se llena din√°micamente -->
        </div>
        <div class="modal-actions">
            <button type="button" class="btn-cancel" onclick="closeDetailModal()">Cerrar</button>
        </div>
    </div>
</div>

<div class="admin-separator"></div>

<!-- Panel de Grupos de Usuarios (solo para superadmin) -->
<div class="grupos-panel">
    <div class="grupos-header">
        <h2><i class="fas fa-users-cog"></i> Panel de Grupos de Usuarios</h2>
        <button class="btn-refresh-grupos" onclick="loadGrupos()">
            <i class="fas fa-sync-alt"></i> Actualizar
        </button>
    </div>
    
    <div class="grupos-content">
        <div class="grupos-grid">
            
            <!-- Grupo Super Admin -->
            <div class="grupo-card super-admin">
                <div class="grupo-header">
                    <div class="grupo-icon">üëë</div>
                    <h3>SUPER ADMIN</h3>
                    <span class="grupo-count" id="count-SUPER_ADMIN">0</span>
                </div>
                <div class="grupo-permisos">
                    <span class="permiso-badge">‚úÖ Acceso Completo</span>
                </div>
                <div class="grupo-usuarios" id="usuarios-SUPER_ADMIN">
                    <!-- Se llenan din√°micamente -->
                </div>
            </div>

            <!-- Grupo Administrador -->
            <div class="grupo-card administrador">
                <div class="grupo-header">
                    <div class="grupo-icon">üõ°Ô∏è</div>
                    <h3>ADMINISTRADOR</h3>
                    <span class="grupo-count" id="count-ADMINISTRADOR">0</span>
                </div>
                <div class="grupo-permisos">
                    <span class="permiso-badge">‚úÖ Usuarios</span>
                    <span class="permiso-badge">‚úÖ Tr√°mites</span>
                    <span class="permiso-badge no">‚ùå Protestas</span>
                </div>
                <div class="grupo-usuarios" id="usuarios-ADMINISTRADOR">
                    <!-- Se llenan din√°micamente -->
                </div>
            </div>

            <!-- Grupo Gestor de Protestas -->
            <div class="grupo-card gestor-protestas">
                <div class="grupo-header">
                    <div class="grupo-icon">üìã</div>
                    <h3>GESTOR PROTESTAS</h3>
                    <span class="grupo-count" id="count-GESTOR_PROTESTAS">0</span>
                </div>
                <div class="grupo-permisos">
                    <span class="permiso-badge">‚úÖ Solo Protestas</span>
                    <span class="permiso-badge no">‚ùå Usuarios</span>
                    <span class="permiso-badge no">‚ùå Tr√°mites</span>
                </div>
                <div class="grupo-usuarios" id="usuarios-GESTOR_PROTESTAS">
                    <!-- Se llenan din√°micamente -->
                </div>
            </div>

            <!-- Grupo Gestor de Tr√°mites -->
            <div class="grupo-card gestor-tramites">
                <div class="grupo-header">
                    <div class="grupo-icon">üìÅ</div>
                    <h3>GESTOR TR√ÅMITES</h3>
                    <span class="grupo-count" id="count-GESTOR_TRAMITES">0</span>
                </div>
                <div class="grupo-permisos">
                    <span class="permiso-badge">‚úÖ Tr√°mites de su √Årea</span>
                    <span class="permiso-badge no">‚ùå Usuarios</span>
                    <span class="permiso-badge no">‚ùå Protestas</span>
                </div>
                <div class="grupo-usuarios" id="usuarios-GESTOR_TRAMITES">
                    <!-- Se llenan din√°micamente -->
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Modal para cambiar grupo de usuario -->
<div id="cambiarGrupoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Cambiar Grupo de Usuario</h3>
            <span class="close" onclick="closeCambiarGrupoModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p><strong>Usuario:</strong> <span id="modalUsuarioNombre"></span></p>
            <p><strong>Grupo actual:</strong> <span id="modalGrupoActual"></span></p>
            
            <div class="form-group">
                <label for="nuevoGrupo">Nuevo grupo:</label>
                <select id="nuevoGrupo" class="form-control">
                    <option value="ADMINISTRADOR">üõ°Ô∏è Administrador</option>
                    <option value="GESTOR_PROTESTAS">üìã Gestor de Protestas</option>
                    <option value="GESTOR_TRAMITES">üìÅ Gestor de Tr√°mites</option>
                </select>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn-cancel" onclick="closeCambiarGrupoModal()">Cancelar</button>
            <button type="button" class="btn-save" id="saveGrupoBtn">Cambiar Grupo</button>
        </div>
    </div>
</div>

<div class="admin-separator"></div>

{% endif %}

<!-- Contenedor de resultados de b√∫squeda -->
<div class="search-results-container" id="searchResults" style="display: none;">
    <div class="search-info">
        <h3 id="searchResultsTitle">Resultados de b√∫squeda</h3>
        <button class="btn-back-catalog" onclick="showCatalog()">
            <i class="fas fa-arrow-left"></i> Volver al cat√°logo
        </button>
    </div>
    <div id="searchResultsContent"></div>
</div>

<!-- Secci√≥n de √Åreas (cat√°logo original) -->
<div class="areas-grid" id="catalogGrid">
    {% for clasificacion in clasificaciones %}
        <a href="{% url 'ver_tramites' clasificacion.id %}" class="area-container">
            <div class="area-item">
                <img src="{% static clasificacion.imagen %}" alt="{{ clasificacion.nombre }}" class="area-image">
            </div>
            <h3 class="area-title">{{ clasificacion.nombre }}</h3>
        </a>
    {% empty %}
        <p>No hay clasificaciones disponibles.</p>
    {% endfor %}
</div>

<style>
/* Estilos para la b√∫squeda */
.search-container {
    position: relative;
    display: flex;
    align-items: center;
}

.clear-search {
    position: absolute;
    right: 50px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: #666;
    display: none;
}

.clear-search:hover {
    color: #333;
}

.search-results-container {
    margin: 2rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.search-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #dee2e6;
}

.search-info h3 {
    margin: 0;
    color: #333;
}

.btn-back-catalog {
    background: #007bff;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background-color 0.3s;
}

.btn-back-catalog:hover {
    background: #0056b3;
}

.search-section {
    margin-bottom: 2rem;
}

.search-section h4 {
    color: #495057;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    border-bottom: 2px solid #007bff;
    padding-bottom: 0.5rem;
}

.search-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: box-shadow 0.3s;
    cursor: pointer;
}

.search-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.search-item h5 {
    margin: 0 0 0.5rem 0;
    color: #333;
}

.search-item p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

.search-item-type {
    display: inline-block;
    background: #007bff;
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 3px;
    font-size: 0.8rem;
    margin-bottom: 0.5rem;
}

.search-item-type.clasificacion {
    background: #28a745;
}

.no-results {
    text-align: center;
    padding: 2rem;
    color: #666;
}

.loading-search {
    text-align: center;
    padding: 2rem;
    color: #007bff;
}

/* Estilos para el panel de protestas */
.protestas-panel {
    background: white;
    border-radius: 10px;
    padding: 2rem;
    margin: 2rem 0;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.protestas-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
}

.protestas-header h2 {
    color: #2c3e50;
    margin: 0;
    font-size: 1.5rem;
}

.protestas-header i {
    margin-right: 10px;
    color: #3498db;
}

.protestas-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.search-protestas, .status-filter {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.9rem;
}

.search-protestas {
    width: 250px;
}

.status-filter {
    width: 150px;
}

.btn-refresh {
    background: #28a745;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.3s;
}

.btn-refresh:hover {
    background: #218838;
}

.protestas-table-container {
    overflow-x: auto;
    margin-bottom: 1rem;
}

.protestas-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.protestas-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
}

.protestas-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.85rem;
}

.protestas-table tbody tr:hover {
    background-color: #f8f9fa;
}

.protesta-folio {
    font-weight: bold;
    color: #2c3e50;
}

.protesta-status {
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
    text-align: center;
    display: inline-block;
    min-width: 80px;
}

.protesta-status.RECIBIDA {
    background: #e3f2fd;
    color: #1976d2;
}

.protesta-status.EN_PROCESO {
    background: #fff3e0;
    color: #f57c00;
}

.protesta-status.APROBADA {
    background: #e8f5e8;
    color: #388e3c;
}

.protesta-status.NEGADA {
    background: #ffebee;
    color: #d32f2f;
}

.protesta-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-action {
    padding: 0.25rem 0.5rem;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s;
}

.btn-action.pdf {
    background: #dc3545;
    color: white;
}

.btn-action.pdf:hover {
    background: #c82333;
    transform: translateY(-1px);
}

.btn-action.status {
    background: #007bff;
    color: white;
}

.btn-action.status:hover {
    background: #0056b3;
    transform: translateY(-1px);
}

.btn-action.detail {
    background: #28a745;
    color: white;
}

.btn-action.detail:hover {
    background: #218838;
    transform: translateY(-1px);
}

.protestas-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
}

.pagination-btn {
    padding: 0.5rem 0.75rem;
    border: 1px solid #ddd;
    background: white;
    color: #333;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.3s;
}

.pagination-btn:hover {
    background: #f8f9fa;
}

.pagination-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.pagination-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-info {
    color: #666;
    font-size: 0.9rem;
}

.detail-modal-content {
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
}

.detail-section {
    margin-bottom: 1.5rem;
}

.detail-section h4 {
    color: #2c3e50;
    border-bottom: 2px solid #3498db;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}

.detail-grid {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.detail-label {
    font-weight: bold;
    color: #555;
}

.detail-value {
    color: #333;
}

.loading-protestas {
    text-align: center;
    padding: 2rem;
    color: #666;
}

.no-protestas {
    text-align: center;
    padding: 2rem;
    color: #666;
}

.no-protestas i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #ddd;
}

/* Estilos para el panel de grupos */
.grupos-panel {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin: 2rem 0;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    border: 1px solid rgba(255,255,255,0.2);
}

.grupos-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 3px solid #e9ecef;
}

.grupos-header h2 {
    color: #2c3e50;
    margin: 0;
    font-size: 1.8rem;
    font-weight: 600;
}

.grupos-header i {
    margin-right: 12px;
    color: #3498db;
}

.btn-refresh-grupos {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    padding: 0.7rem 1.2rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-refresh-grupos:hover {
    background: linear-gradient(135deg, #218838, #1ea788);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.grupos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
}

.grupo-card {
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
    border-radius: 12px;
    padding: 1.5rem;
    border: 2px solid;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.grupo-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--card-color), var(--card-color-light));
}

.grupo-card.super-admin {
    --card-color: #e74c3c;
    --card-color-light: #f39c12;
    border-color: #e74c3c;
}

.grupo-card.administrador {
    --card-color: #3498db;
    --card-color-light: #2980b9;
    border-color: #3498db;
}

.grupo-card.gestor-protestas {
    --card-color: #9b59b6;
    --card-color-light: #8e44ad;
    border-color: #9b59b6;
}

.grupo-card.gestor-tramites {
    --card-color: #27ae60;
    --card-color-light: #2ecc71;
    border-color: #27ae60;
}

.grupo-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
}

.grupo-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.grupo-icon {
    font-size: 2rem;
    margin-right: 10px;
}

.grupo-header h3 {
    flex: 1;
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #2c3e50;
}

.grupo-count {
    background: var(--card-color);
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.85rem;
    font-weight: bold;
    min-width: 30px;
    text-align: center;
}

.grupo-permisos {
    margin-bottom: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.permiso-badge {
    font-size: 0.75rem;
    padding: 0.3rem 0.6rem;
    border-radius: 12px;
    font-weight: 500;
    background: #e8f5e8;
    color: #2e7d32;
    border: 1px solid #a5d6a7;
}

.permiso-badge.no {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ffcdd2;
}

.grupo-usuarios {
    max-height: 300px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #ccc transparent;
}

.grupo-usuarios::-webkit-scrollbar {
    width: 6px;
}

.grupo-usuarios::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.grupo-usuarios::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
}

.usuario-item {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 0.8rem;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.usuario-item:hover {
    background: #f8f9fa;
    border-color: var(--card-color);
    transform: translateX(5px);
}

.usuario-item:last-child {
    margin-bottom: 0;
}

.usuario-nombre {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.3rem;
}

.usuario-detalles {
    font-size: 0.85rem;
    color: #6c757d;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.usuario-area {
    color: #495057;
}

.btn-cambiar-grupo {
    background: var(--card-color);
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-cambiar-grupo:hover {
    opacity: 0.8;
    transform: scale(1.05);
}

.loading-grupos {
    text-align: center;
    padding: 2rem;
    color: #666;
}

.no-usuarios {
    text-align: center;
    padding: 1rem;
    color: #999;
    font-style: italic;
}

@media (max-width: 768px) {
    .grupos-grid {
        grid-template-columns: 1fr;
    }
    
    .grupo-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .grupo-count {
        align-self: flex-end;
    }
    
    .grupos-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .protestas-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .protestas-controls {
        flex-direction: column;
        width: 100%;
    }
    
    .search-protestas, .status-filter {
        width: 100%;
    }
    
    .protestas-table th,
    .protestas-table td {
        padding: 0.5rem;
        font-size: 0.8rem;
    }
    
    .protesta-actions {
        flex-direction: column;
    }
}
</style>

<script>
// Variables globales
let currentEditUserId = null;
let allClasificaciones = [];
let searchTimeout = null;
let isSearching = false;

// Variables globales para protestas
let currentProtestasPage = 1;
let protestasData = [];
let allStatusChoices = [];
let currentEditProtestaId = null;

// Variables globales para grupos
let gruposData = {};
let currentEditUserGrupoId = null;

// Cargar datos al inicio
document.addEventListener('DOMContentLoaded', function() {
    // Solo cargar usuarios si es superadmin
    if (document.getElementById('usersTable')) {
        loadUsers();
    }
    
    // Solo cargar protestas si es superadmin
    if (document.getElementById('protestasTable')) {
        loadProtestas();
        setupProtestasSearch();
    }
    
    // Solo cargar grupos si es superadmin
    if (document.getElementById('count-SUPER_ADMIN')) {
        loadGrupos();
    }
    
    // Configurar b√∫squeda
    setupSearch();
});

// Configurar funcionalidad de b√∫squeda
function setupSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const clearSearch = document.getElementById('clearSearch');
    
    // B√∫squeda en tiempo real mientras escribe
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length === 0) {
            showCatalog();
            clearSearch.style.display = 'none';
            return;
        }
        
        if (query.length >= 2) {
            clearSearch.style.display = 'block';
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300); // Esperar 300ms despu√©s de que termine de escribir
        }
    });
    
    // B√∫squeda al hacer clic en el bot√≥n
    searchButton.addEventListener('click', function() {
        const query = searchInput.value.trim();
        if (query) {
            performSearch(query);
            // Scroll inmediato hacia los resultados al hacer clic en la lupa
            setTimeout(() => {
                const searchResultsElement = document.getElementById('searchResults');
                if (searchResultsElement.style.display !== 'none') {
                    searchResultsElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            }, 200);
        }
    });
    
    // B√∫squeda al presionar Enter
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
                performSearch(query);
                // Scroll hacia los resultados al presionar Enter
                setTimeout(() => {
                    const searchResultsElement = document.getElementById('searchResults');
                    if (searchResultsElement.style.display !== 'none') {
                        searchResultsElement.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }
                }, 200);
            }
        }
    });
    
    // Limpiar b√∫squeda
    clearSearch.addEventListener('click', function() {
        searchInput.value = '';
        showCatalog();
        clearSearch.style.display = 'none';
        searchInput.focus();
    });
}

// Realizar b√∫squeda
async function performSearch(query) {
    if (isSearching) return;
    
    isSearching = true;
    showSearchResults();
    showLoadingSearch();
    
    try {
        const response = await fetch(`/api/buscar/?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (response.ok) {
            displaySearchResults(data, query);
        } else {
            showSearchError('Error al realizar la b√∫squeda');
        }
    } catch (error) {
        showSearchError('Error de conexi√≥n: ' + error.message);
    } finally {
        isSearching = false;
    }
}

// Mostrar contenedor de resultados
function showSearchResults() {
    document.getElementById('searchResults').style.display = 'block';
    document.getElementById('catalogGrid').style.display = 'none';
    
    // Scroll autom√°tico hacia los resultados con animaci√≥n suave
    setTimeout(() => {
        const searchResultsElement = document.getElementById('searchResults');
        searchResultsElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }, 100); // Peque√±o delay para que el elemento se muestre primero
}

// Mostrar cat√°logo original
function showCatalog() {
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('catalogGrid').style.display = 'grid';
    updateCatalogTitle();
    
    // Scroll suave hacia el cat√°logo (t√≠tulo principal)
    setTimeout(() => {
        const catalogTitle = document.getElementById('catalogTitle');
        catalogTitle.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
    }, 100);
}

// Actualizar t√≠tulo del cat√°logo
function updateCatalogTitle() {
    document.getElementById('catalogTitle').innerHTML = `
        CAT√ÅLOGO MUNICIPAL DE<br>
        <span class="catalog-highlight">TR√ÅMITES Y SERVICIOS</span>
    `;
}

// Mostrar indicador de carga
function showLoadingSearch() {
    document.getElementById('searchResultsContent').innerHTML = `
        <div class="loading-search">
            <i class="fas fa-spinner fa-spin"></i> Buscando...
        </div>
    `;
}

// Mostrar error de b√∫squeda
function showSearchError(message) {
    document.getElementById('searchResultsContent').innerHTML = `
        <div class="no-results">
            <i class="fas fa-exclamation-triangle"></i>
            <p>${message}</p>
        </div>
    `;
}

// Mostrar resultados de b√∫squeda
function displaySearchResults(data, query) {
    const { clasificaciones, tramites, total } = data;
    
    // Actualizar t√≠tulo
    document.getElementById('searchResultsTitle').innerHTML = `
        Resultados para "<strong>${query}</strong>" (${total} encontrados)
    `;
    
    let html = '';
    
    if (total === 0) {
        html = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h4>No se encontraron resultados</h4>
                <p>No hay tr√°mites o servicios que coincidan con "<strong>${query}</strong>"</p>
                <p>Intenta con otros t√©rminos de b√∫squeda</p>
            </div>
        `;
    } else {
        // Mostrar clasificaciones encontradas
        if (clasificaciones.length > 0) {
            html += `
                <div class="search-section">
                    <h4><i class="fas fa-folder"></i> √Åreas (${clasificaciones.length})</h4>
            `;
            
            clasificaciones.forEach(clasificacion => {
                html += `
                    <div class="search-item" onclick="window.location.href='/tramites/${clasificacion.id}/'">
                        <span class="search-item-type clasificacion">√ÅREA</span>
                        <h5>${clasificacion.nombre}</h5>
                        <p>Ver todos los tr√°mites de esta √°rea</p>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        // Mostrar tr√°mites encontrados
        if (tramites.length > 0) {
            html += `
                <div class="search-section">
                    <h4><i class="fas fa-file-alt"></i> Tr√°mites (${tramites.length})</h4>
            `;
            
            tramites.forEach(tramite => {
                html += `
                    <div class="search-item" onclick="window.location.href='/tramite/${tramite.id}/'">
                        <span class="search-item-type">TR√ÅMITE</span>
                        <h5>${tramite.nombre}</h5>
                        <p>${tramite.descripcion}</p>
                        <small><i class="fas fa-tag"></i> ${tramite.clasificacion_nombre}</small>
                    </div>
                `;
            });
            
            html += '</div>';
        }
    }
    
    document.getElementById('searchResultsContent').innerHTML = html;
}

// === FUNCIONES PARA USUARIOS ===

// Funci√≥n para cargar usuarios
async function loadUsers() {
    try {
        const response = await fetch('/api/users/');
        const data = await response.json();
        
        if (data.error) {
            showAlert(data.error, 'error');
            return;
        }
        
        allClasificaciones = data.clasificaciones;
        populateClasificacionSelect();
        populateUsersTable(data.users);
    } catch (error) {
        showAlert('Error al cargar usuarios: ' + error.message, 'error');
    }
}

// Funci√≥n para poblar la tabla de usuarios
function populateUsersTable(users) {
    const tbody = document.getElementById('usersTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    users.forEach(user => {
        const row = createUserRow(user);
        tbody.appendChild(row);
    });
}

// Funci√≥n para crear una fila de usuario
function createUserRow(user) {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${user.username}</td>
        <td>${user.first_name} ${user.last_name}</td>
        <td>${user.email || '-'}</td>
        <td>${user.clasificacion_nombre}</td>
        <td>
            <span class="status-badge ${user.is_active ? 'active' : 'inactive'}">
                ${user.is_active ? 'Activo' : 'Inactivo'}
            </span>
        </td>
        <td>
            <span class="role-badge ${user.is_staff ? 'admin' : 'user'}">
                ${user.is_staff ? 'Admin' : 'Usuario'}
            </span>
        </td>
        <td>${user.date_joined}</td>
        <td class="actions">
            <button class="btn-action edit" onclick="editUser(${user.id})" title="Editar">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn-action delete" onclick="confirmDeleteUser(${user.id}, '${user.username}')" title="Eliminar">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    return row;
}

// Funci√≥n para poblar el select de clasificaciones
function populateClasificacionSelect() {
    const select = document.getElementById('clasificacion');
    if (!select) return;
    
    select.innerHTML = '<option value="">Sin √°rea asignada</option>';
    
    allClasificaciones.forEach(clasificacion => {
        const option = document.createElement('option');
        option.value = clasificacion.id;
        option.textContent = clasificacion.nombre;
        select.appendChild(option);
    });
}

// Funci√≥n para abrir modal de crear usuario
function openCreateUserModal() {
    currentEditUserId = null;
    document.getElementById('modalTitle').textContent = 'Crear Usuario';
    document.getElementById('passwordRequired').style.display = 'inline';
    document.getElementById('password').required = true;
    document.getElementById('userForm').reset();
    document.getElementById('is_active').checked = true;
    document.getElementById('userModal').style.display = 'block';
}

// Funci√≥n para editar usuario
function editUser(userId) {
    const tbody = document.getElementById('usersTableBody');
    const rows = tbody.getElementsByTagName('tr');
    
    for (let row of rows) {
        const cells = row.getElementsByTagName('td');
        if (cells.length > 0) {
            // Encontrar la fila del usuario y extraer datos
            const editBtn = row.querySelector('.btn-action.edit');
            if (editBtn && editBtn.getAttribute('onclick').includes(userId)) {
                currentEditUserId = userId;
                document.getElementById('modalTitle').textContent = 'Editar Usuario';
                document.getElementById('passwordRequired').style.display = 'none';
                document.getElementById('password').required = false;
                
                // Rellenar el formulario con los datos actuales
                document.getElementById('username').value = cells[0].textContent;
                const fullName = cells[1].textContent.split(' ');
                document.getElementById('first_name').value = fullName[0] || '';
                document.getElementById('last_name').value = fullName.slice(1).join(' ') || '';
                document.getElementById('email').value = cells[2].textContent !== '-' ? cells[2].textContent : '';
                
                // Encontrar la clasificaci√≥n
                const clasificacionNombre = cells[3].textContent;
                const clasificacion = allClasificaciones.find(c => c.nombre === clasificacionNombre);
                document.getElementById('clasificacion').value = clasificacion ? clasificacion.id : '';
                
                // Estado y rol
                document.getElementById('is_active').checked = cells[4].textContent.includes('Activo');
                document.getElementById('is_staff').checked = cells[5].textContent.includes('Admin');
                
                document.getElementById('userModal').style.display = 'block';
                break;
            }
        }
    }
}

// Funci√≥n para cerrar modal de usuario
function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
    document.getElementById('userForm').reset();
    currentEditUserId = null;
}

// Funci√≥n para confirmar eliminaci√≥n
function confirmDeleteUser(userId, username) {
    document.getElementById('confirmMessage').textContent = 
        `¬øEst√°s seguro de que deseas eliminar al usuario "${username}"?`;
    document.getElementById('confirmDeleteBtn').onclick = () => deleteUser(userId);
    document.getElementById('confirmModal').style.display = 'block';
}

// Funci√≥n para cerrar modal de confirmaci√≥n
function closeConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
}

// Funci√≥n para eliminar usuario
async function deleteUser(userId) {
    try {
        const response = await fetch('/api/users/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user_id: userId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            loadUsers();
        } else {
            showAlert(data.error, 'error');
        }
    } catch (error) {
        showAlert('Error al eliminar usuario: ' + error.message, 'error');
    }
    
    closeConfirmModal();
}

// Funci√≥n para manejar el env√≠o del formulario
document.getElementById('userForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const userData = {
        username: formData.get('username'),
        email: formData.get('email'),
        first_name: formData.get('first_name'),
        last_name: formData.get('last_name'),
        clasificacion_id: formData.get('clasificacion') || null,
        is_active: document.getElementById('is_active').checked,
        is_staff: document.getElementById('is_staff').checked
    };
    
    const password = formData.get('password');
    if (password) {
        userData.password = password;
    }
    
    if (currentEditUserId) {
        userData.user_id = currentEditUserId;
        if (password) {
            userData.new_password = password;
        }
    }
    
    const url = currentEditUserId ? '/api/users/update/' : '/api/users/create/';
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            closeUserModal();
            loadUsers();
        } else {
            showAlert(data.error, 'error');
        }
    } catch (error) {
        showAlert('Error al guardar usuario: ' + error.message, 'error');
    }
});

// === FUNCIONES PARA PROTESTAS ===

// Configurar b√∫squeda de protestas
function setupProtestasSearch() {
    const searchInput = document.getElementById('searchProtestas');
    const statusFilter = document.getElementById('statusFilter');
    let searchTimeout;
    
    // B√∫squeda en tiempo real
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentProtestasPage = 1;
            loadProtestas();
        }, 500);
    });
    
    // Filtro por estatus
    statusFilter.addEventListener('change', function() {
        currentProtestasPage = 1;
        loadProtestas();
    });
}

// Cargar lista de protestas
async function loadProtestas() {
    try {
        showProtestasLoading();
        
        const searchTerm = document.getElementById('searchProtestas').value;
        const statusFilter = document.getElementById('statusFilter').value;
        
        const params = new URLSearchParams({
            page: currentProtestasPage,
            search: searchTerm,
            status: statusFilter
        });
        
        const response = await fetch(`/api/protestas/?${params}`);
        const data = await response.json();
        
        if (response.ok) {
            protestasData = data.protestas;
            allStatusChoices = data.status_choices;
            populateProtestasTable(data.protestas);
            renderProtestasPagination(data.pagination);
            populateStatusFilter(data.status_choices);
        } else {
            showProtestasError(data.error || 'Error al cargar protestas');
        }
    } catch (error) {
        showProtestasError('Error de conexi√≥n: ' + error.message);
    }
}

// Mostrar indicador de carga protestas
function showProtestasLoading() {
    const tbody = document.getElementById('protestasTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="loading-protestas">
                <i class="fas fa-spinner fa-spin"></i> Cargando protestas...
            </td>
        </tr>
    `;
}

// Mostrar error protestas
function showProtestasError(message) {
    const tbody = document.getElementById('protestasTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="no-protestas">
                <i class="fas fa-exclamation-triangle"></i>
                <p>${message}</p>
            </td>
        </tr>
    `;
}

// Poblar tabla de protestas
function populateProtestasTable(protestas) {
    const tbody = document.getElementById('protestasTableBody');
    
    if (protestas.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="no-protestas">
                    <i class="fas fa-inbox"></i>
                    <p>No se encontraron protestas</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    
    protestas.forEach(protesta => {
        const row = createProtestaRow(protesta);
        tbody.appendChild(row);
    });
}

// Crear fila de protesta
function createProtestaRow(protesta) {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <span class="protesta-folio">${protesta.folio}</span>
        </td>
        <td>${protesta.nombre_completo}</td>
        <td title="${protesta.tramite_nombre}">
            ${protesta.tramite_nombre.length > 30 ? 
              protesta.tramite_nombre.substring(0, 30) + '...' : 
              protesta.tramite_nombre}
        </td>
        <td>${protesta.area}</td>
        <td>
            <span class="protesta-status ${protesta.estatus}">${protesta.estatus_display}</span>
        </td>
        <td>${protesta.fecha_creacion}</td>
        <td class="protesta-actions">
            <button class="btn-action pdf" onclick="generateProtestaPDF(${protesta.id})" title="Descargar PDF">
                <i class="fas fa-file-pdf"></i>
            </button>
            <button class="btn-action status" onclick="openStatusModal(${protesta.id})" title="Cambiar Estatus">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn-action detail" onclick="showProtestaDetail(${protesta.id})" title="Ver Detalles">
                <i class="fas fa-eye"></i>
            </button>
        </td>
    `;
    return row;
}

// Renderizar paginaci√≥n
function renderProtestasPagination(pagination) {
    const container = document.getElementById('protestasPagination');
    
    if (pagination.total_pages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = `
        <div class="pagination-info">
            Mostrando p√°gina ${pagination.current_page} de ${pagination.total_pages} 
            (${pagination.total_count} protestas total)
        </div>
    `;
    
    // Bot√≥n anterior
    html += `
        <button class="pagination-btn ${!pagination.has_previous ? 'disabled' : ''}" 
                onclick="goToProtestasPage(${pagination.previous_page})" 
                ${!pagination.has_previous ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i> Anterior
        </button>
    `;
    
    // N√∫meros de p√°gina
    const startPage = Math.max(1, pagination.current_page - 2);
    const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <button class="pagination-btn ${i === pagination.current_page ? 'active' : ''}" 
                    onclick="goToProtestasPage(${i})">
                ${i}
            </button>
        `;
    }
    
    // Bot√≥n siguiente
    html += `
        <button class="pagination-btn ${!pagination.has_next ? 'disabled' : ''}" 
                onclick="goToProtestasPage(${pagination.next_page})" 
                ${!pagination.has_next ? 'disabled' : ''}>
            Siguiente <i class="fas fa-chevron-right"></i>
        </button>
    `;
    
    container.innerHTML = html;
}

// Ir a p√°gina espec√≠fica
function goToProtestasPage(page) {
    if (page && page > 0) {
        currentProtestasPage = page;
        loadProtestas();
    }
}

// Poblar filtro de estatus
function populateStatusFilter(statusChoices) {
    const select = document.getElementById('statusFilter');
    
    // Limpiar opciones existentes excepto la primera
    while (select.children.length > 1) {
        select.removeChild(select.lastChild);
    }
    
    statusChoices.forEach(choice => {
        const option = document.createElement('option');
        option.value = choice.value;
        option.textContent = choice.label;
        select.appendChild(option);
    });
}

// Generar PDF de protesta
async function generateProtestaPDF(protestaId) {
    try {
        // Mostrar indicador de carga
        showAlert('Generando PDF...', 'info');
        
        const response = await fetch(`/api/protesta/${protestaId}/pdf/`);
        
        if (response.ok) {
            // Crear enlace de descarga
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Protesta_${getProtestaFolio(protestaId)}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('PDF generado exitosamente', 'success');
        } else {
            const errorData = await response.json();
            showAlert('Error al generar PDF: ' + errorData.error, 'error');
        }
    } catch (error) {
        showAlert('Error al generar PDF: ' + error.message, 'error');
    }
}

// Obtener folio de protesta por ID
function getProtestaFolio(protestaId) {
    const protesta = protestasData.find(p => p.id === protestaId);
    return protesta ? protesta.folio : 'protesta';
}

// Abrir modal para cambiar estatus
function openStatusModal(protestaId) {
    const protesta = protestasData.find(p => p.id === protestaId);
    if (!protesta) return;
    
    currentEditProtestaId = protestaId;
    
    document.getElementById('statusModalFolio').textContent = protesta.folio;
    document.getElementById('statusModalSolicitante').textContent = protesta.nombre_completo;
    document.getElementById('statusModalCurrentStatus').textContent = protesta.estatus_display;
    
    // Poblar select de nuevo estatus
    const select = document.getElementById('newStatus');
    select.innerHTML = '';
    
    allStatusChoices.forEach(choice => {
        if (choice.value !== protesta.estatus) { // No mostrar el estatus actual
            const option = document.createElement('option');
            option.value = choice.value;
            option.textContent = choice.label;
            select.appendChild(option);
        }
    });
    
    document.getElementById('statusModal').style.display = 'block';
}

// Cerrar modal de estatus
function closeStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
    currentEditProtestaId = null;
}

// Cambiar estatus de protesta
document.getElementById('saveStatusBtn').addEventListener('click', async function() {
    if (!currentEditProtestaId) return;
    
    const newStatus = document.getElementById('newStatus').value;
    if (!newStatus) {
        showAlert('Selecciona un nuevo estatus', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/protesta/status/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                protesta_id: currentEditProtestaId,
                estatus: newStatus
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            closeStatusModal();
            loadProtestas(); // Recargar tabla
        } else {
            showAlert(data.error, 'error');
        }
    } catch (error) {
        showAlert('Error al cambiar estatus: ' + error.message, 'error');
    }
});

// Mostrar detalles de protesta
function showProtestaDetail(protestaId) {
    const protesta = protestasData.find(p => p.id === protestaId);
    if (!protesta) return;
    
    const modalBody = document.getElementById('detailModalBody');
    
    modalBody.innerHTML = `
        <div class="detail-section">
            <h4>Informaci√≥n General</h4>
            <div class="detail-grid">
                <span class="detail-label">Folio:</span>
                <span class="detail-value">${protesta.folio}</span>
                <span class="detail-label">Fecha:</span>
                <span class="detail-value">${protesta.fecha_creacion}</span>
                <span class="detail-label">Estatus:</span>
                <span class="detail-value">
                    <span class="protesta-status ${protesta.estatus}">${protesta.estatus_display}</span>
                </span>
            </div>
        </div>
        
        <div class="detail-section">
            <h4>Solicitante</h4>
            <div class="detail-grid">
                <span class="detail-label">Nombre:</span>
                <span class="detail-value">${protesta.nombre_completo}</span>
                <span class="detail-label">Email:</span>
                <span class="detail-value">${protesta.email}</span>
                <span class="detail-label">Tel√©fono:</span>
                <span class="detail-value">${protesta.telefono}</span>
            </div>
        </div>
        
        <div class="detail-section">
            <h4>Tr√°mite</h4>
            <div class="detail-grid">
                <span class="detail-label">Nombre:</span>
                <span class="detail-value">${protesta.tramite_nombre}</span>
                <span class="detail-label">√Årea:</span>
                <span class="detail-value">${protesta.area}</span>
                <span class="detail-label">Servidor P√∫blico:</span>
                <span class="detail-value">${protesta.servidor_publico}</span>
            </div>
        </div>
        
        <div class="detail-section">
            <h4>Motivo</h4>
            <div class="detail-grid">
                <span class="detail-label">Motivo:</span>
                <span class="detail-value">${protesta.motivo_display}</span>
            </div>
        </div>
    `;
    
    document.getElementById('detailModal').style.display = 'block';
}

// Cerrar modal de detalles
function closeDetailModal() {
    document.getElementById('detailModal').style.display = 'none';
}

// === FUNCIONES PARA GRUPOS ===

// Cargar datos de grupos
async function loadGrupos() {
    try {
        showGruposLoading();
        
        const response = await fetch('/api/grupos/');
        const data = await response.json();
        
        if (response.ok) {
            gruposData = data.grupos;
            populateGrupos(data.grupos);
        } else {
            showGruposError(data.error || 'Error al cargar grupos');
        }
    } catch (error) {
        showGruposError('Error de conexi√≥n: ' + error.message);
    }
}

// Mostrar indicador de carga grupos
function showGruposLoading() {
    const grupos = ['SUPER_ADMIN', 'ADMINISTRADOR', 'GESTOR_PROTESTAS', 'GESTOR_TRAMITES'];
    
    grupos.forEach(grupo => {
        const container = document.getElementById(`usuarios-${grupo}`);
        if (container) {
            container.innerHTML = `
                <div class="loading-grupos">
                    <i class="fas fa-spinner fa-spin"></i> Cargando...
                </div>
            `;
        }
    });
}

// Mostrar error grupos
function showGruposError(message) {
    const grupos = ['SUPER_ADMIN', 'ADMINISTRADOR', 'GESTOR_PROTESTAS', 'GESTOR_TRAMITES'];
    
    grupos.forEach(grupo => {
        const container = document.getElementById(`usuarios-${grupo}`);
        if (container) {
            container.innerHTML = `
                <div class="no-usuarios">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                </div>
            `;
        }
    });
}

// Poblar grupos con usuarios
function populateGrupos(grupos) {
    const grupoKeys = ['SUPER_ADMIN', 'ADMINISTRADOR', 'GESTOR_PROTESTAS', 'GESTOR_TRAMITES'];
    
    grupoKeys.forEach(grupoKey => {
        const usuarios = grupos[grupoKey] || [];
        const countElement = document.getElementById(`count-${grupoKey}`);
        const containerElement = document.getElementById(`usuarios-${grupoKey}`);
        
        if (countElement) {
            countElement.textContent = usuarios.length;
        }
        
        if (containerElement) {
            if (usuarios.length === 0) {
                containerElement.innerHTML = `
                    <div class="no-usuarios">
                        <i class="fas fa-user-slash"></i> Sin usuarios asignados
                    </div>
                `;
            } else {
                containerElement.innerHTML = '';
                usuarios.forEach(usuario => {
                    const usuarioElement = createUsuarioElement(usuario, grupoKey);
                    containerElement.appendChild(usuarioElement);
                });
            }
        }
    });
}

// Crear elemento de usuario
function createUsuarioElement(usuario, grupo) {
    const div = document.createElement('div');
    div.className = 'usuario-item';
    div.innerHTML = `
        <div class="usuario-nombre">${usuario.username}</div>
        <div class="usuario-detalles">
            <span class="usuario-area">${usuario.area || 'Sin √°rea'}</span>
            ${grupo !== 'SUPER_ADMIN' ? `<button class="btn-cambiar-grupo" onclick="openCambiarGrupoModal(${usuario.id}, '${usuario.username}', '${grupo}')">Cambiar</button>` : ''}
        </div>
    `;
    return div;
}

// Abrir modal para cambiar grupo
function openCambiarGrupoModal(userId, username, grupoActual) {
    currentEditUserGrupoId = userId;
    
    const gruposDisplay = {
        'SUPER_ADMIN': 'üëë Super Administrador',
        'ADMINISTRADOR': 'üõ°Ô∏è Administrador',
        'GESTOR_PROTESTAS': 'üìã Gestor de Protestas',
        'GESTOR_TRAMITES': 'üìÅ Gestor de Tr√°mites'
    };
    
    document.getElementById('modalUsuarioNombre').textContent = username;
    document.getElementById('modalGrupoActual').textContent = gruposDisplay[grupoActual];
    
    // Configurar el select (sin SUPER_ADMIN para evitar problemas)
    const select = document.getElementById('nuevoGrupo');
    select.value = grupoActual !== 'SUPER_ADMIN' ? grupoActual : 'ADMINISTRADOR';
    
    // Deshabilitar la opci√≥n actual
    Array.from(select.options).forEach(option => {
        option.disabled = option.value === grupoActual;
    });
    
    document.getElementById('cambiarGrupoModal').style.display = 'block';
}

// Cerrar modal cambiar grupo
function closeCambiarGrupoModal() {
    document.getElementById('cambiarGrupoModal').style.display = 'none';
    currentEditUserGrupoId = null;
}

// Cambiar grupo de usuario
document.getElementById('saveGrupoBtn').addEventListener('click', async function() {
    if (!currentEditUserGrupoId) return;
    
    const nuevoGrupo = document.getElementById('nuevoGrupo').value;
    if (!nuevoGrupo) {
        showAlert('Selecciona un nuevo grupo', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/cambiar-grupo/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: currentEditUserGrupoId,
                nuevo_grupo: nuevoGrupo
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            closeCambiarGrupoModal();
            loadGrupos(); // Recargar grupos
        } else {
            showAlert(data.error, 'error');
        }
    } catch (error) {
        showAlert('Error al cambiar grupo: ' + error.message, 'error');
    }
});

// === FUNCI√ìN PARA MOSTRAR ALERTAS ===

// Funci√≥n para mostrar alertas
function showAlert(message, type) {
    // Crear el elemento de alerta
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        <span>${message}</span>
        <button type="button" class="alert-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    // Insertar al inicio del contenido
    const content = document.querySelector('main') || document.body;
    content.insertBefore(alert, content.firstChild);
    
    // Auto-remover despu√©s de 5 segundos
    setTimeout(() => {
        if (alert.parentElement) {
            alert.remove();
        }
    }, 5000);
}

// === CERRAR MODALES AL HACER CLIC FUERA ===

// Cerrar modales al hacer clic fuera de ellos
window.onclick = function(event) {
    const userModal = document.getElementById('userModal');
    const confirmModal = document.getElementById('confirmModal');
    const statusModal = document.getElementById('statusModal');
    const detailModal = document.getElementById('detailModal');
    const cambiarGrupoModal = document.getElementById('cambiarGrupoModal');
    
    if (event.target === userModal) {
        closeUserModal();
    }
    if (event.target === confirmModal) {
        closeConfirmModal();
    }
    if (event.target === statusModal) {
        closeStatusModal();
    }
    if (event.target === detailModal) {
        closeDetailModal();
    }
    if (event.target === cambiarGrupoModal) {
        closeCambiarGrupoModal();
    }
}
</script>

{% endblock %}